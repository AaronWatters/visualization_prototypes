<html>
<head>
<title>Image detail viewer</title>
<meta name="viewport" content="width=device-width, user-scalable=no">
<meta charset="utf-8" />
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" />
<link rel="stylesheet" href="../css/normalize.css" />
<link rel="stylesheet" href="../css/base.css" />
<link rel="stylesheet" href="./styles.css" />
<link rel="stylesheet" href="../css/jquery-ui.css" />

    <link rel="stylesheet" href="https://aaronwatters.github.io/jp_doodle/jquery-ui-1.12.1/jquery-ui.css">
    <script src="https://aaronwatters.github.io/jp_doodle/jquery-ui-1.12.1/external/jquery/jquery.js"></script>
    <script src="https://aaronwatters.github.io/jp_doodle/jquery-ui-1.12.1/jquery-ui.js"></script>
    <script src="https://aaronwatters.github.io/jp_doodle/jp_doodle_js/canvas_2d_widget_helper.js"></script>
    <script src="https://aaronwatters.github.io/jp_doodle/jp_doodle_js/dual_canvas_helper.js"></script>
    <link rel=stylesheet href="https://aaronwatters.github.io/jp_doodle/static/style.css">
</head>
<body>
    <div class="layout"> <div class="section"> <div class="image-detail">
    
        <h4 class="title">Image detail viewer.</h4>
        <p>
            This demo shows a large image in two panels.  
            The left image shows the whole image at low resolution and the right panel shows part of the image in full resolution.
        </p>

        <p>
            Drag the mouse over the left panel to change the region of interest viewed in the right panel.
        </p>

        <div id="target_div"></div>

        <button onClick="window.location.reload();">Refit to viewport</button>
    </div> </div> </div>

    <script>
        var image_url = "example.png";
        var canvas_width = 600;
        const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0)
        //const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0)
        canvas_width = Math.max(Math.ceil(vw * 0.45), canvas_width);

        var element = $('#target_div');
        
        var canvases = $("<div></div>").appendTo(element);
        canvases.addClass("canvases");
        canvases.css("display", "flex");
        var whole = $("<div>whole image here.</div>").appendTo(canvases);
        whole.addClass("whole-image");
        var detail = $("<div>image detail here.</div>").appendTo(canvases);
        detail.addClass("detail-image");

        var gamma_area = $("<div></div>").appendTo(element);
        gamma_area.addClass("gamma-area");
        gamma_area.css("display", "flex");
        var label = $("<div>Gamma:</div>").appendTo(gamma_area);
        label.addClass("gamma-label");
        var slider = $("<div>slider here.</div>").appendTo(gamma_area);
        slider.addClass("gamma-slider");
        var gamma_value = $("<div>gamma_value here.</div>").appendTo(gamma_area);
        gamma_value.addClass("gamma-value");
        $("<div> &nbsp; Zoom: </div>").appendTo(gamma_area);
        var zoom_select = $('<select>  <option value="1">1x</option> </select>').appendTo(gamma_area);
        for (var i=2; i<5; i++) {
            $( `<option value="${i}">${i}x</option>`).appendTo(zoom_select);
        }
        var $img = $('<img src="' + image_url + '"/>').appendTo(element);
        $img.hide();
        var img=$img[0];

        var gamma_correction_table = function(gamma) {
            var result = [];
            for (var i=0; i<256; i++) {
                result.push( Math.floor( 255 * Math.pow(( i / 255 ), gamma) ));
            }
            return result;
        };

        var gamma_correct = function(pixels, gamma) {
            var correction = gamma_correction_table(gamma);
            var result = pixels.slice();
            for (var i=0; i<pixels.length; i++) {
                result[i] = correction[pixels[i]]
            }
            return result;
        };

        img.onload = function () {
            var zoom = 1.0;
            var whole_width = img.width;
            var whole_height = img.height;
            // draw the image into a hidden canvas and then get the pixels
            var hcanvas = $(`<canvas width="${whole_width}px" height="${whole_height}px" tabindex="0"/>`);
            var hcontext = hcanvas[0].getContext("2d");
            hcontext.drawImage(img, 0, 0);
            var imgData = hcontext.getImageData(0, 0, whole_width, whole_height);
            var imgArray = imgData.data;
            // choose a canvas width that is an integer divisor of image width (?)
            var max_width = vw * 0.4;
            canvas_width = whole_width;
            var divisor = 1;
            while (canvas_width > max_width) {
                divisor += 1;
                canvas_width = whole_width / divisor;
            }
            var canvas_height = canvas_width * whole_height * (1.0 / whole_width);
            var config = {
                width: canvas_width,
                height: canvas_height,
                image_smoothing: true,
            };
            whole.empty();
            detail.empty();
            whole.dual_canvas_helper(config);
            detail.dual_canvas_helper(config);
            var info = $('<div class="info-text"/>').html("wh: " + [whole_width, whole_height, canvas_width, canvas_height]).appendTo(element);

            var gamma = 1.0;

            var update_images = function() {
                gamma = slider.slider("option", "value");
                gamma_value.html("" + gamma)
                var correctedArray = gamma_correct(imgArray, gamma);
                whole.name_image_data("example", correctedArray, whole_width, whole_height);
                // whole.name_image_url("example", image_url);
                // detail.name_image_url("example", image_url);
                detail.name_image_data("example", correctedArray, whole_width, whole_height);
                whole.request_redraw();
                detail.request_redraw();
            };

            slider.empty();
            slider.width(500);
            slider.slider({
                value: gamma,
                slide: update_images,
                min: 0.2,
                max: 4.0,
                step: 0.2,
            });

            update_images();
            var detail_image = detail.named_image({image_name: "example", x:0, y:0, w:whole_width, h:whole_height, name:true});
            var whole_image = whole.named_image({image_name: "example", x:0, y:0, w:canvas_width, h:canvas_height, name:true});

            // frame in image coordinates (origin top left, y going down),
            var wframe = whole.frame_region(
                0, canvas_height, canvas_width, 0,
                0, 0, whole_width, whole_height
            );
            
            var detail_rectangle = wframe.frame_rect({
                x:canvas_width, y:whole_height-canvas_height, 
                w:canvas_width, h:canvas_height, color: "#f55", fill:false, name: true, events: false, lineWidth:3,
            });
            var event_rectangle = wframe.frame_rect({
                x: 0, y:0, w:whole_width, h: whole_height, color: "rgba(0,0,0,0)", name:true,
            });

            var last_position = null;

            var set_position = function(position) {
                last_position = position;
                var zw = canvas_width / zoom;
                var zh = canvas_height / zoom;
                var x = position.x - zw/2;
                var y = position.y + zh/2;
                x = Math.min(x, whole_width - zw);
                y = Math.max(y, zh);
                x = Math.max(x, 0)
                y = Math.min(y,  whole_height)
                x = Math.round(x);
                y = Math.round(y);
                //info.html("position: " + [x, y])
                var offset_x = x;
                var offset_y = whole_height - y;
                detail_rectangle.change({x: x, y: y-zh, w:zw, h:zh});
                detail_image.change({x: -offset_x * zoom, y: -offset_y * zoom, w:whole_width * zoom, h:whole_height*zoom});
            }

            set_position({x: (whole_width - canvas_width)/2, y: (whole_height - canvas_height)/2+canvas_height})

            var pressed = false;

            var track_detail = function(event) {
                var etype = event.type;
                if (etype == "mousedown") {
                    pressed = true;
                }
                if (etype == "mouseup") {
                    pressed = false;
                }
                if (!pressed) {
                    return;
                }
                var position = event.model_location;
                set_position(position)
            };
            event_rectangle.on("mousemove", track_detail);
            event_rectangle.on("mouseup", track_detail);
            event_rectangle.on("mousedown", track_detail);

            zoom_select.on('change', function() {
                debugger;
                var val = zoom_select.val();
                zoom = parseInt(zoom_select.val());
                set_position(last_position);
            });

        };
    </script>
</body>
</html>
